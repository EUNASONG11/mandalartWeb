<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green1st.mandalartWeb.mandalart.MandalartMapper">
    <!--여기서 프로젝트 title , user - nickname , project - createdAt -->
    <select id="getMandalart">
        SELECT mandalart_id AS mandalartId
        , a.parent_id AS parentId
        , a.title
        , a.contents
        , a.completed_fg AS completedFg
        , a.depth
        , a.start_date AS startDate
        , a.finish_date AS finishDate
        , a.order_id AS orderId
        FROM mandalart a
        WHERE a.project_id = #{projectId}
        ORDER BY a.depth , a.parent_id
    </select>

    <select id="getImProject">
        SELECT COUNT(mandalart_id) AS cnt, A.project_id , A.title
        FROM mandalart A
        JOIN project B
        ON A.project_id = B.project_id
        WHERE B.user_id = #{userId}
        AND DATEDIFF(finish_date , CURDATE()) <![CDATA[ <= ]]> 7
        AND DATEDIFF(finish_date , CURDATE()) <![CDATA[ >= ]]> 0
        GROUP BY A.project_id;
    </select>

    <select id="graphMandalart">
        SELECT
        mandalart_id AS mandalartId,
        completed_fg AS completedFg,
        parent_id AS parentId,
        order_id AS orderId
        FROM mandalart
        WHERE project_id = #{projectId}
        AND parent_id = #{parentId}
        AND order_id BETWEEN #{startOrderId} AND #{endOrderId}
        AND order_id >= #{startOrderId} AND order_id <![CDATA[ <= ]]> #{endOrderId}
    </select>

    <update id="patchMandalart">
        UPDATE mandalart
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="contents != null">contents = #{contents},</if>
            <if test="completedFg != null">completed_fg = #{completedFg},</if>
            <if test="startDate != null">start_date = #{startDate},</if>
            <if test="finishDate != null">finish_date = #{finishDate},</if>
        </set>
        WHERE
        mandalart_id = #{mandalartId}
        <if test="parentId != null">
            AND (
            #{startDate} IS NULL
            OR #{finishDate} IS NULL
            OR EXISTS (
            SELECT 1
            FROM mandalart parent
            WHERE parent.mandalart_id = #{parentId}
            AND (#{startDate} IS NULL OR parent.start_date <![CDATA[ <= ]]> #{startDate})
            AND (#{finishDate} IS NULL OR parent.finish_date <![CDATA[ >= ]]> #{finishDate})
            AND (#{startDate} IS NULL OR parent.finish_date <![CDATA[ <> ]]> #{startDate})
            )
            )
        </if>
    </update>

</mapper>